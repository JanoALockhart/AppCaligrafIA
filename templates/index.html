<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Calligraphy Recommendation Prototype</title>
    <style>
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
        }
        .section {
            border: 1px solid #ccc;
            padding: 10px;
        }
        .row-container {
            border: 1px solid #ccc;
            padding: 6px;
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .row-image {
            max-height: 80px;
            border: 1px solid #aaa;
        }
        .accuracy {
            font-family: sans-serif;
        }

        #image-preview {
            width: 300px;
            height: 470px;     
            border: 1px solid #ccc;
            display: none;
            margin-top: 10px;
            object-fit: contain;
        }
    </style>
</head>
<body>

    <h1>Calligraphy Analyzer</h1>
    <div class="grid-container">
        <div class="section">
            <a href="{{ url_for('download_sheet') }}">Download Template</a>

            <br><br>
            
            <form method="POST" action="{{ url_for('analyse') }}" enctype="multipart/form-data">
                <label for="model">Select model:</label>
                <select id="model" name="model">
                    {% for m in models %}
                    <option value="{{ m.id }}">{{ m.name }}</option>
                    {% endfor %}
                </select>

                <br><br>

                <label for="image">Upload image:</label>
                <input type="file" id="image" name="image" accept="image/*" onchange="previewImage(event)">
                
                <br><br>
                <label>Or choose a default:</label>
                <select name="default_image" id="defaultSelect">
                    <option value="">-- Select Image --</option>
                    <option value="/static/imprenta_mayuscula.jpeg">Imprenta Mayuscula</option>
                    <option value="/static/imprenta_minuscula.jpeg">Imprenta Minuscula</option>
                    <option value="/static/cursiva_minuscula.jpeg">Cursiva Minuscula</option>
                    <option value="/static/cursiva_mayuscula.jpeg">Cursiva Mayuscula</option>
                </select>

                <br><br>
                <button type="submit">Analyze</button>

                <img id="image-preview" src="/static/imprenta_mayuscula.jpeg">

                <br><br>

                
            </form>
        </div>
        
        <div class="section">
            <h2>Extracted Rows</h2>
            {% if img_rows and recomendations and predictions %}
            <table>
                <tr>
                    <th>Letter</th>
                    <th>Image</th>
                    <th>Model's Prediction</th>
                    <th>Accuracy</th>
                </tr>
                {% for letter, image in img_rows.items() %}
                <tr>
                    <th>{{ letter }}:</th>
                    <th>
                        <img src="data:image/png;base64, {{ image }}" width="512">
                    </th>
                    <th>{{ predictions[letter] }}</th>
                    <th>{{ "%.2f"|format(recomendations[letter] * 100) }}%</th>
                </tr>
                {% endfor %}
                
            </table>
            {% endif %}
        </div>

        <div class="section">
            <h2>Recomendations</h2>
            {% if recomendations %} 
            <form action="{{ url_for('download_recommendations') }}" method="POST">
                <input type="hidden" name="recomendations" value='{{ recomendations | tojson | safe }}'>
                
                <label>Top letters:</label>
                <input type="number" name="top_letters" min="1" max="26" step="1" value="5">
                <br>
                <label>Rows per letter:</label>
                <input type="number" name="rows_per_letter" min="1" step="1" value="3">

                <button type="submit">Download Custom Activity</button>
            </form>
            <br>
            <table>
                <tr>
                    <th>Letter</th>
                    <th>Accuracy</th>
                </tr>
                {% for letter, accuracy in recomendations.items() %}
                <tr>
                    <th>{{ letter }}:</th>
                    <th>
                        {{ "%.2f"|format(accuracy * 100) }}%
                    </th>
                </tr>
                {% endfor %}
                
            </table>
            {% endif %}
        </div>
    </div>


<script>
    function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const preview = document.getElementById('image-preview');
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';

        const select = document.getElementById("defaultSelect")
        select.value = ""
    }

    document.getElementById('defaultSelect').addEventListener('change', function() {
        const preview = document.getElementById('image-preview');
        preview.src = this.value || "";
        preview.style.display = 'block'
        const fileInput = document.getElementById("image");
        fileInput.value = ""
    });
</script>
</body>
</html>
